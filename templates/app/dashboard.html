{% extends 'app/base.html' %}

{% block title %}CatCare Dashboard{% endblock %}

{% block extra_css %}
<style>
    .disease-alert {
        background: linear-gradient(135deg, #fff9c4, #fef3c7);
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    #diseaseResults .alert {
        margin-bottom: 0;
        animation: slideInUp 0.3s ease-out;
    }
    
    .feed-log.new-feed {
        background: linear-gradient(135deg, #e8f5e8, #d4edda);
        border-left: 3px solid #28a745;
        padding: 8px;
        margin: 2px 0;
        border-radius: 4px;
        animation: slideInDown 0.5s ease-out;
    }
    
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-wifi fa-2x mb-2"></i>
                    <h6>Tr·∫°ng th√°i thi·∫øt b·ªã</h6>
                    <span id="deviceStatus" class="badge fs-6 {% if device_status == 'online' %}status-online{% else %}status-offline{% endif %}">
                        {{ device_status|title }}
                    </span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-cogs fa-2x mb-2"></i>
                    <h6>Ch·∫ø ƒë·ªô ho·∫°t ƒë·ªông</h6>
                <span id="currentMode" class="fs-4 fw-bold mode-badge {% if current_mode == 'auto' %}mode-auto{% else %}mode-manual{% endif %}">
                        {% if current_mode == 'auto' %}T·ª± ƒë·ªông{% else %}Th·ªß c√¥ng{% endif %}
                    </span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h6>L·ªãch ƒë√£ ƒë·∫∑t</h6>
                    <span class="fs-4 fw-bold">{{ feeding_schedules.count }}</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-utensils fa-2x mb-2"></i>
                    <h6>L·∫ßn cho ƒÉn h√¥m nay</h6>
                    <span class="fs-4 fw-bold">{{ feed_logs.count }}</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Video Stream -->
            <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>Camera tr·ª±c ti·∫øp
                        </h5>
                    <div class="d-flex align-items-center gap-3">
                        <div id="cameraStatus" class="camera-status">
                            <i class="fas fa-video me-1"></i>ƒêang k·∫øt n·ªëi...
                        </div>
                        <div id="deviceConnectionStatus" class="device-status">
                            <i class="fas fa-wifi me-1"></i>
                            <span class="badge {% if device_status == 'online' %}status-online{% else %}status-offline{% endif %}">
                                {{ device_status|title }}
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="video-container">
                            <canvas id="videoCanvas" class="video-stream" style="display: none;"></canvas>
                            <div id="videoLoading" class="video-loading">
                                <div class="text-center p-5">
                                    <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                                    <p>ƒêang k·∫øt n·ªëi RTSP stream...</p>
                                </div>
                            </div>
                            <div id="videoError" class="video-error" style="display: none;">
                                <div class="text-center p-5">
                                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                                    <p>Kh√¥ng th·ªÉ k·∫øt n·ªëi RTSP stream</p>
                                    <button class="btn btn-primary btn-sm" onclick="retryVideoConnection()">
                                        <i class="fas fa-redo me-1"></i>Th·ª≠ l·∫°i
                                    </button>
                                </div>
                            </div>
                            <div class="position-absolute top-0 end-0 p-3">
                            <button class="btn btn-detect" data-action="detect-disease">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Disease Detection Results - Desktop Only -->
                <div class="mt-3 d-none d-lg-block">
                    <div id="diseaseResults" style="display: none;"></div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="col-lg-4">
                <!-- Manual Feed -->
            <div class="card mb-4 d-none">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">
                            <i class="fas fa-hand-paper me-2"></i>ƒêi·ªÅu khi·ªÉn th·ªß c√¥ng
                        </h6>
                    </div>
                    <div class="card-body text-center">
                    <button class="btn btn-feed w-100 mb-3" data-action="manual-feed">
                            <i class="fas fa-utensils me-2"></i>Cho ƒÉn ngay
                        </button>
                        <div class="form-check form-switch d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" id="modeSwitch" 
                               {% if current_mode == 'auto' %}checked{% endif %} data-action="toggle-mode">
                            <label class="form-check-label ms-2" for="modeSwitch">
                                Ch·∫ø ƒë·ªô t·ª± ƒë·ªông
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Recent Feeding Logs -->
                <div class="card mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-history me-2"></i>L·ªãch s·ª≠ cho ƒÉn g·∫ßn ƒë√¢y
                        </h6>
                    <a href="{% url 'app:feeding_history' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list me-1"></i>Xem t·∫•t c·∫£
                    </a>
                    </div>
                    <div class="card-body">
                        {% if feed_logs %}
                        <div class="feed-logs-container">
                            {% for log in feed_logs %}
                            <div class="feed-log">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-utensils me-1"></i>
                                        {% if log.mode == 'auto' %}T·ª± ƒë·ªông{% else %}Th·ªß c√¥ng{% endif %}
                                    </span>
                                    <small class="text-muted">{{ log.timestamp|date:"H:i d/m" }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                            <p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch s·ª≠ cho ƒÉn</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Feeding Schedules -->
                <div class="card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-clock me-2"></i>L·ªãch cho ƒÉn
                        </h6>
                    <a href="{% url 'app:settings' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Th√™m l·ªãch
                    </a>
                    </div>
                    <div class="card-body">
                        {% if feeding_schedules %}
                        <div class="schedule-container">
                            {% for schedule in feeding_schedules %}
                            <div class="schedule-item">
                                <i class="fas fa-clock me-2"></i>
                                {{ schedule.time|time:"H:i" }}
                                {% if schedule.enabled %}
                                    <span class="badge bg-success ms-2">Ho·∫°t ƒë·ªông</span>
                                {% else %}
                                    <span class="badge bg-secondary ms-2">T·∫Øt</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                            <p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch cho ƒÉn</p>
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Toast Container for Mobile -->
    <div class="toast-container position-fixed top-0 end-0 p-3 d-lg-none">
        <div id="diseaseToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-cat text-primary me-2"></i>
                <strong class="me-auto"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="diseaseToastBody">
                <!-- Toast content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Floating Controls -->
<!-- Desktop Version -->
<div class="floating-controls d-none d-md-flex flex-column">
    <button class="control-btn control-feed" data-action="manual-feed">
            <i class="fas fa-utensils"></i>
        </button>
    <button class="control-btn control-detect" data-action="detect-disease">
            <i class="fas fa-search"></i>
        </button>
    <button class="control-btn control-mode" data-action="toggle-mode-quick">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<!-- Mobile FAB Menu -->
<div class="floating-controls d-md-none">
    <div class="mobile-fab-menu">
        <div class="fab-options" id="fabOptions">
            <button class="control-btn control-mode" data-action="toggle-mode-quick" data-close-fab="true">
            <i class="fas fa-sync-alt"></i>
            </button>
            <button class="control-btn control-detect" data-action="detect-disease" data-close-fab="true">
                <i class="fas fa-search"></i>
            </button>
            <button class="control-btn control-feed" data-action="manual-feed" data-close-fab="true">
                <i class="fas fa-utensils"></i>
            </button>
        </div>
        <button class="fab-main" id="fabMain" data-action="toggle-fab-menu">
            <i class="fas fa-plus"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>
    
    $(document).ready(function() {
        $('body').append('<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">');
        
        let videoSocket = null;
        let statusSocket = null;
        
        function getCsrfToken() {
            return $('[name=csrfmiddlewaretoken]').val();
        }

        function manualFeed() {
            $.ajax({
                url: "{% url 'app:manual_feed' %}",
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                success: function(data) {
                    if (data.success) {
                        showAlert('success', data.message);
                        
                        // C·∫≠p nh·∫≠t ngay daily_count n·∫øu c√≥
                        if (data.daily_count !== undefined) {
                            const $statsCard = $('.stats-card').eq(3);
                            const $countElement = $statsCard.find('.fs-4.fw-bold');
                            
                            $countElement.fadeOut(200, function() {
                                $countElement.text(data.daily_count).fadeIn(200);
                            });
                            
                            $statsCard.addClass('stats-updated');
                            setTimeout(function() {
                                $statsCard.removeClass('stats-updated');
                            }, 600);
                            
                            // Th√™m v√†o l·ªãch s·ª≠ ngay l·∫≠p t·ª©c (fallback cho WebSocket)
                            const feedData = {
                                mode: 'manual',
                                timestamp: new Date().toISOString(),
                                device_id: 'manual_web',
                                daily_count: data.daily_count
                            };
                            addNewFeedToHistory(feedData);
                        }
                        
                        // WebSocket s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t ph·∫ßn c√≤n l·∫°i (n·∫øu c√≥)
                    } else {
                        showAlert('danger', data.message);
                    }
                },
                error: function() {
                    showAlert('danger', 'L·ªói k·∫øt n·ªëi');
                }
            });
        }

        function toggleMode() {
            const isAuto = $('#modeSwitch').is(':checked');
            const mode = isAuto ? 'auto' : 'manual';
            
            $.ajax({
                url: "{% url 'app:change_mode' %}",
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({mode: mode}),
                success: function(data) {
                if (data.success) {
                    updateModeDisplay(data.mode);
                    showAlert('success', `ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô ${data.mode === 'auto' ? 't·ª± ƒë·ªông' : 'th·ªß c√¥ng'}`);
                } else {
                        $('#modeSwitch').prop('checked', !isAuto);
                    showAlert('danger', data.message);
                    }
                },
                error: function() {
                    $('#modeSwitch').prop('checked', !isAuto);
                    showAlert('danger', 'L·ªói k·∫øt n·ªëi');
                }
            });
        }

        let detectionActive = false;

                  function detectDisease() {
              if (videoSocket && videoSocket.readyState === WebSocket.OPEN) {
                  if (!detectionActive) {
                      videoSocket.send(JSON.stringify({command: 'start_detection'}));
                      detectionActive = true;
                  }
                  
                  videoSocket.send(JSON.stringify({command: 'detect_once'}));
                  
                  const $button = $('[data-action="detect-disease"]');
                  const originalHtml = $button.html();
                  $button.html('<i class="fas fa-spinner fa-spin"></i>');
                  $button.prop('disabled', true);
                  
                  setTimeout(() => {
                      $button.html('<i class="fas fa-search"></i>');
                      $button.prop('disabled', false);
                  }, 10000);
                
            } else {
                showAlert('danger', 'Ch∆∞a k·∫øt n·ªëi video stream');
            }
        }
        
        function displayDetectionResults(data) {
            const isMobile = window.innerWidth < 992;
            
            if (isMobile) {
                showDiseaseToast(data);
            } else {
                showDiseaseAlert(data);
            }
            
            updateDetectionCameraStatus(data);
        }
        
        function displayDiseaseResults(data) {
            console.log('üíä Hi·ªÉn th·ªã k·∫øt qu·∫£ ph√°t hi·ªán b·ªánh:', data);
            
            const $resultsDiv = $('#diseaseResults');
            let html = '';
            
            if (data.cat_detected) {
                if (data.diseases && data.diseases.length > 0) {
                    html = `<div class="alert alert-warning alert-dismissible fade show">
                        <h6><i class="fas fa-cat me-2"></i>Ph√°t hi·ªán m√®o - C√≥ ${data.diseases.length} b·ªánh ƒë∆∞·ª£c ph√°t hi·ªán:</h6>`;
                    
                    data.diseases.forEach((disease, index) => {
                        const diseaseName = disease.disease_vn || disease.disease || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh' || disease.disease_vn || disease.disease || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh' || disease.name || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh';
                        const confidence = Math.round(Math.round(disease.confidence || 0) || 0);
                        html += `<div class="disease-alert mt-2">
                            <strong>${diseaseName}</strong> - ƒê·ªô tin c·∫≠y: ${confidence}%
                            ${disease.disease_vn || disease.disease || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh' ? `<small class="text-muted d-block">(${disease.disease_vn || disease.disease || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh'})</small>` : ''}
                        </div>`;
                    });
                    
                    html += `<button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button></div>`;
                } else {
                    html = `<div class="alert alert-success alert-dismissible fade show">
                        <h6><i class="fas fa-cat me-2"></i>Ph√°t hi·ªán m√®o kh·ªèe m·∫°nh</h6>
                        <small class="text-muted">Kh√¥ng ph√°t hi·ªán b·ªánh n√†o</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                    </div>`;
                }
            } else {
                html = `<div class="alert alert-info alert-dismissible fade show">
                    <i class="fas fa-search me-2"></i>Kh√¥ng ph√°t hi·ªán m√®o trong video
                    <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                </div>`;
            }
            
            $resultsDiv.html(html);
            $resultsDiv.show();
        }
        
        function closeDiseaseResults() {
            $('#diseaseResults').hide();
        }
        
        function showDiseaseAlert(data) {
            const $resultsDiv = $('#diseaseResults');
            
            let html = '';
            let alertType = 'info';
            
            if (data.cat_detected) {
                const cropStatus = data.cat_cropped ? 
                    '<small class="text-success"><i class="fas fa-check me-1"></i>Crop m√®o th√†nh c√¥ng</small>' : 
                    '<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Kh√¥ng th·ªÉ crop m√®o</small>';
                
                if (data.diseases.length > 0) {
                    alertType = 'warning';
                    html = `<div class="alert alert-${alertType} alert-dismissible fade show">
                        <h6><i class="fas fa-cat me-2"></i>Ph√°t hi·ªán m√®o - C√≥ ${data.total_diseases} b·ªánh ƒë∆∞·ª£c ph√°t hi·ªán:</h6>
                        <div class="mb-2">${cropStatus}</div>`;
                    
                    data.diseases.forEach((disease, index) => {
                        html += `<div class="disease-alert mt-2">
                            <strong>${disease.disease_vn || disease.disease || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh'}</strong> - ƒê·ªô tin c·∫≠y: ${Math.round(disease.confidence || 0)}%
                            <small class="text-muted d-block">(${disease.disease_en || disease.english_name || 'Unknown'})</small>
                        </div>`;
                    });
                    
                    html += `<button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button></div>`;
                } else {
                    alertType = 'success';
                    html = `<div class="alert alert-${alertType} alert-dismissible fade show">
                        <h6><i class="fas fa-cat me-2"></i>Ph√°t hi·ªán m√®o kh·ªèe m·∫°nh</h6>
                        <div class="mb-2">${cropStatus}</div>
                        <small class="text-muted">${data.message || 'Kh√¥ng ph√°t hi·ªán b·ªánh'}</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                    </div>`;
                }
            } else {
                alertType = 'info';
                html = `<div class="alert alert-${alertType} alert-dismissible fade show">
                    <i class="fas fa-search me-2"></i>Kh√¥ng ph√°t hi·ªán m√®o trong video
                    <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                </div>`;
            }
            
            $resultsDiv.html(html);
            $resultsDiv.show();
        }
        
        function showDiseaseToast(data) {
            const $toastBody = $('#diseaseToastBody');
            const $toast = $('#diseaseToast');
            
            let content = '';
            let toastClass = 'text-bg-info';
            
            if (data.cat_detected) {
                const cropInfo = data.cat_cropped ? 'Crop th√†nh c√¥ng' : 'Kh√¥ng th·ªÉ crop';
                
                if (data.diseases && data.diseases.length > 0) {
                    toastClass = 'text-bg-warning';
                    content = `<strong>Ph√°t hi·ªán m√®o ‚Üí ${cropInfo}</strong><br>`;
                    content += `<small>C√≥ ${data.total_diseases} b·ªánh ƒë∆∞·ª£c ph√°t hi·ªán:</small><br>`;
                    
                    data.diseases.forEach((disease, index) => {
                        content += `<small>‚Ä¢ ${disease.disease_vn || disease.disease || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh'} (${Math.round(disease.confidence || 0)}%)</small><br>`;
                    });
                } else {
                    toastClass = 'text-bg-success';
                    content = `<strong>Ph√°t hi·ªán m√®o kh·ªèe m·∫°nh</strong><br><small>${cropInfo} ‚Üí Kh√¥ng c√≥ b·ªánh</small>`;
                }
            } else {
                toastClass = 'text-bg-info';
                content = '<strong>Kh√¥ng ph√°t hi·ªán m√®o</strong><br><small>ƒêang ti·∫øp t·ª•c t√¨m ki·∫øm...</small>';
            }
            
            $toast.removeClass('text-bg-success text-bg-warning text-bg-info').addClass(toastClass);
            $toastBody.html(content);
            
            const toast = new bootstrap.Toast($toast[0], {
                delay: 5000 
            });
            toast.show();
        }
        
        function updateDetectionCameraStatus(data) {
            if (data.cat_detected) {
                if (data.diseases && data.diseases.length > 0) {
                    updateCameraStatus({
                        detection_info: {
                            cat_detected: true,
                            confidence: data.cat_confidence || 0,
                            disease_detected: true,
                            disease_name: data.diseases[0].disease,
                            disease_confidence: data.diseases[0].confidence
                        }
                    });
                } else {
                    updateCameraStatus({
                        detection_info: {
                            cat_detected: true,
                            confidence: data.cat_confidence || 0,
                            disease_detected: false
                        }
                    });
                }
            } else {
                updateCameraStatus({
                    detection_info: {
                        cat_detected: false,
                        confidence: 0,
                        disease_detected: false
                    }
                });
            }
        }
        
        function closeDiseaseResults() {
            $('#diseaseResults').hide();
        }
        
        function showDiseaseToast(data) {
            let toastHtml = '';
            let toastClass = '';
            
            if (data.cat_detected) {
                if (data.diseases && data.diseases.length > 0) {
                    toastClass = 'bg-warning';
                    toastHtml = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-cat me-2"></i>
                            <div class="flex-grow-1">
                                <strong>Ph√°t hi·ªán ${data.total_diseases} b·ªánh</strong>
                                <div class="small mt-1">
                                    ${data.diseases.map(d => d.disease || d.name || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh').join(', ')}
                                </div>
                                ${data.frames_analyzed ? `<div class="small text-muted">Ph√¢n t√≠ch ${data.frames_analyzed} frames</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    toastClass = 'bg-success';
                    toastHtml = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-cat me-2"></i>
                            <div class="flex-grow-1">
                                <strong>M√®o kh·ªèe m·∫°nh</strong>
                                <div class="small">Kh√¥ng ph√°t hi·ªán b·ªánh</div>
                                ${data.frames_analyzed ? `<div class="small text-muted">Ph√¢n t√≠ch ${data.frames_analyzed} frames</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            } else {
                toastClass = 'bg-info';
                toastHtml = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-search me-2"></i>
                        <div class="flex-grow-1">
                            <strong>Kh√¥ng ph√°t hi·ªán m√®o</strong>
                            <div class="small">${data.message || 'Kh√¥ng c√≥ m√®o trong khung h√¨nh'}</div>
                        </div>
                    </div>
                `;
            }
            
            // T·∫°o toast element
            const toastId = 'diseaseToast' + Date.now();
            const toast = $(`
                <div class="toast ${toastClass} text-white" id="${toastId}" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <div class="toast-body">
                        ${toastHtml}
                        <button type="button" class="btn-close btn-close-white float-end" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);
            
            $('body').append(toast);
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast[0], {
                autohide: true,
                delay: 8000
            });
            bsToast.show();
            
            toast[0].addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }
        
        $(document).on('click', '#diseaseResults .btn-close', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeDiseaseResults();
        });
        
        $(document).on('click', '#diseaseToast .btn-close', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const toast = bootstrap.Toast.getInstance(document.getElementById('diseaseToast'));
            if (toast) {
                toast.hide();
            }
        });

        function displayDiseaseResults(data) {
            console.log('üöÄ displayDiseaseResults called with:', data);
            const $resultsDiv = $('#diseaseResults');
            console.log('üìç resultsDiv element:', $resultsDiv.length > 0 ? 'FOUND' : 'NOT FOUND');
            
            let html = '';
            
            if (data.cat_detected) {
                const cropStatus = data.cat_cropped ? 
                    '<small class="text-success"><i class="fas fa-check me-1"></i>Crop m√®o th√†nh c√¥ng</small>' : 
                    '<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Kh√¥ng th·ªÉ crop m√®o</small>';
                
                const analysisInfo = data.frames_analyzed ? 
                    `<small class="text-info d-block"><i class="fas fa-chart-line me-1"></i>ƒê√£ ph√¢n t√≠ch ${data.frames_analyzed} frames trong 5 gi√¢y</small>` : '';
                
                if (data.diseases && data.diseases.length > 0) {
                    const catConfidence = data.cat_confidence ? `(${Math.round(data.cat_confidence * 100)}%)` : '';
                    html = `<div class="alert alert-warning alert-dismissible fade show">
                        <h6><i class="fas fa-cat me-2"></i>Ph√°t hi·ªán m√®o ${catConfidence} - C√≥ ${data.total_diseases} b·ªánh ƒë∆∞·ª£c ph√°t hi·ªán:</h6>
                        <div class="mb-2">${cropStatus}</div>
                        <div class="mb-2">${analysisInfo}</div>`;
                    
                    data.diseases.forEach((disease, index) => {
                        const detectionStats = disease.detection_count ? 
                            `<small class="text-muted d-block">Xu·∫•t hi·ªán trong ${disease.detection_count}/${data.frames_analyzed} frames (${Math.round((disease.appearance_rate || 0) * 100)}%)</small>` : '';
                        
                        html += `<div class="disease-alert mt-2">
                            <strong>${disease.disease_vn || disease.disease || 'B·ªánh kh√¥ng x√°c ƒë·ªãnh'}</strong> - ƒê·ªô tin c·∫≠y: ${Math.round(disease.confidence || 0)}%
                            <small class="text-muted d-block">(${disease.disease_en || disease.english_name || 'Unknown'})</small>
                            ${detectionStats}
                        </div>`;
                    });
                    
                    html += `<button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button></div>`;
                    
                    const topDisease = data.diseases[0];
                    updateCameraStatus({
                        detection_info: {
                            cat_detected: true,
                            confidence: data.cat_confidence || 0, 
                            disease_detected: true,
                            disease_name: topDisease.disease,
                            disease_confidence: topDisease.confidence
                        }
                    });
                } else {
                    const catConfidence = data.cat_confidence ? `(${Math.round(data.cat_confidence * 100)}%)` : '';
                    html = `<div class="alert alert-success alert-dismissible fade show">
                        <h6><i class="fas fa-cat me-2"></i>Ph√°t hi·ªán m√®o kh·ªèe m·∫°nh ${catConfidence}</h6>
                        <div class="mb-2">${cropStatus}</div>
                        <div class="mb-2">${analysisInfo}</div>
                        <small class="text-muted">${data.message || 'Kh√¥ng ph√°t hi·ªán b·ªánh'}</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                    </div>`;
                    
                    updateCameraStatus({
                        detection_info: {
                            cat_detected: true,
                            confidence: data.cat_confidence || 0,
                            disease_detected: false
                        }
                    });
                }
            } else {
                html = `<div class="alert alert-info alert-dismissible fade show">
                    <i class="fas fa-search me-2"></i>${data.message || 'Kh√¥ng ph√°t hi·ªán m√®o trong khung h√¨nh'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                </div>`;
                
                updateCameraStatus({
                    detection_info: {
                        cat_detected: false,
                        confidence: 0,
                        disease_detected: false
                    }
                });
            }
            
            $resultsDiv.html(html);
            $resultsDiv.show();
            
            if ($resultsDiv[0]) {
                $resultsDiv[0].scrollIntoView({behavior: 'smooth', block: 'nearest'});
            }
            
            if (!data.diseases || data.diseases.length === 0) {
                setTimeout(() => {
                    $resultsDiv.fadeOut();
                }, 8000);
            }
            
        }

        function updateModeDisplay(mode) {
            const $modeElement = $('#currentMode');
            $modeElement.removeClass('mode-auto mode-manual').addClass(`mode-badge ${mode === 'auto' ? 'mode-auto' : 'mode-manual'}`);
            $modeElement.text(mode === 'auto' ? 'T·ª± ƒë·ªông' : 'Th·ªß c√¥ng');
        }

        function updateStatus() {
            $.ajax({
                url: "{% url 'app:get_status' %}",
                method: 'GET',
                success: function(data) {
                    const $statusElement = $('#deviceStatus');
                    $statusElement.removeClass('status-online status-offline')
                               .addClass(`badge fs-6 ${data.device_status === 'online' ? 'status-online' : 'status-offline'}`)
                               .text(data.device_status === 'online' ? 'Online' : 'Offline');
                    
                    const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
                    $deviceConnectionStatus.removeClass('status-online status-offline')
                                          .addClass(data.device_status === 'online' ? 'status-online' : 'status-offline')
                                          .text(data.device_status === 'online' ? 'Online' : 'Offline');
                
                    updateModeDisplay(data.current_mode);
                    $('#modeSwitch').prop('checked', data.current_mode === 'auto');
                    
                },
                error: function() {
                    console.log('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i');
                    const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
                    $deviceConnectionStatus.removeClass('status-online status-offline')
                                          .addClass('status-offline')
                                          .text('API Error');
                }
            });
        }

        function updateCameraStatus(data) {
            const $cameraStatus = $('#cameraStatus');
            
            $cameraStatus.removeClass('error disease-detected healthy');
            
            if (data.camera_error) {
                $cameraStatus.addClass('error')
                            .html(`<i class="fas fa-exclamation-triangle me-1"></i>${data.camera_error}`);
            } else if (data.detection_info) {
                const detection = data.detection_info;
                if (detection.disease_detected) {
                    $cameraStatus.addClass('disease-detected')
                                .html(`<i class="fas fa-virus me-1"></i>${detection.disease_name} (${detection.disease_confidence}%)`);
                } else if (detection.cat_detected) {
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-cat me-1"></i>Ph√°t hi·ªán m√®o (${detection.confidence}%)`);
                } else {
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-search me-1"></i>ƒêang t√¨m ki·∫øm m√®o...`);
                }
            } else if (data.disease_info && data.disease_info.detected) {
                const disease = data.disease_info;
                $cameraStatus.addClass('disease-detected')
                            .html(`<i class="fas fa-virus me-1"></i>${disease.name} (${Math.round(disease.confidence || 0)}%)`);
            } else {
                $cameraStatus.addClass('healthy')
                            .html(`<i class="fas fa-video me-1"></i>Camera s·∫µn s√†ng`);
            }
        }
        
        function updateCameraStreamStatus(status) {
            const $cameraStatus = $('#cameraStatus');
            $cameraStatus.removeClass('error disease-detected healthy');
            
            switch(status) {
                case 'connecting':
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-spinner fa-spin me-1"></i>ƒêang k·∫øt n·ªëi camera...`);
                    break;
                case 'connected':
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-video me-1"></i>Camera ho·∫°t ƒë·ªông`);
                    break;
                case 'error':
                    $cameraStatus.addClass('error')
                                .html(`<i class="fas fa-exclamation-triangle me-1"></i>L·ªói camera stream`);
                    break;
                default:
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-video me-1"></i>Camera s·∫µn s√†ng`);
            }
        }

        function updateFeedingData() {
            $.ajax({
                url: "{% url 'app:get_feeding_data' %}",
                method: 'GET',
                success: function(data) {
                    if (data.success) {
                        const $statsCard = $('.stats-card').eq(3);
                        const $countElement = $statsCard.find('.fs-4.fw-bold');
                        
                        $countElement.text(data.today_feed_count);
                        $statsCard.addClass('stats-updated');
                        
                        setTimeout(function() {
                            $statsCard.removeClass('stats-updated');
                        }, 600);
                        
                        updateFeedingHistory(data.recent_feeds);
                    }
                },
                error: function() {
                    console.log('L·ªói c·∫≠p nh·∫≠t d·ªØ li·ªáu cho ƒÉn');
                }
            });
        }

        function updateFeedingHistory(feeds) {
            const $container = $('.feed-logs-container');
            
            if (feeds && feeds.length > 0) {
                let html = '';
                feeds.forEach(function(feed, index) {
                    const feedTime = new Date(feed.timestamp).toLocaleString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        day: '2-digit',
                        month: '2-digit'
                    });
                    
                    const newFeedClass = index === 0 ? 'new-feed' : '';
                    
                    html += `
                        <div class="feed-log ${newFeedClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="fas fa-utensils me-1"></i>
                                    ${feed.mode === 'auto' ? 'T·ª± ƒë·ªông' : 'Th·ªß c√¥ng'}
                                </span>
                                <small class="text-muted">${feedTime}</small>
                            </div>
                        </div>
                    `;
                });
                
                $container.html(html);
                
                $container.scrollTop(0);
                
                setTimeout(function() {
                    $('.feed-log.new-feed').removeClass('new-feed');
                }, 500);
            } else {
                $container.parent().html('<p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch s·ª≠ cho ƒÉn</p>');
            }
        }

        function showAlert(type, message) {
            const $alertDiv = $(`
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append($alertDiv);
            
            setTimeout(function() {
                $alertDiv.remove();
            }, 5000);
        }

        function toggleFabMenu() {
            $('#fabMain, #fabOptions').toggleClass('active');
        }
        
        function closeFabMenu() {
            $('#fabMain, #fabOptions').removeClass('active');
        }
        
        function toggleModeQuick() {
            const $modeSwitch = $('#modeSwitch');
            if ($modeSwitch.length) {
                $modeSwitch.prop('checked', !$modeSwitch.is(':checked'));
                toggleMode();
            }
        }

        // Event handlers
        $(document).on('click', '[data-action="manual-feed"]', function() {
            manualFeed();
            if ($(this).data('close-fab')) closeFabMenu();
        });

        $(document).on('change', '[data-action="toggle-mode"]', function() {
            toggleMode();
        });

        $(document).on('click', '[data-action="detect-disease"]', function() {
            detectDisease();
            if ($(this).data('close-fab')) closeFabMenu();
        });

        $(document).on('click', '[data-action="toggle-mode-quick"]', function() {
            toggleModeQuick();
            if ($(this).data('close-fab')) closeFabMenu();
        });

        $(document).on('click', '[data-action="toggle-fab-menu"]', function() {
            toggleFabMenu();
        });

        function setupVideoWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/video_stream/`;
            
            updateCameraStreamStatus('connecting');
            
            videoSocket = new WebSocket(wsUrl);
            
            videoSocket.onopen = function(e) {
                videoSocket.send(JSON.stringify({command: 'start_stream'}));
            };
            
            videoSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('WebSocket message received:', data); 
                
                if (data.type === 'disease_detection_result') {
                    console.log('DISEASE DETECTION RESULT RECEIVED:', data);
                }
                
                if (data.type === 'video_frame') {
                    displayVideoFrame(data.image);
                } else if (data.type === 'error') {
                    showVideoError(data.message);
                } else if (data.type === 'status') {
                    updateCameraStreamStatus('connecting');
                    console.log('Status message:', data.message);
                } else if (data.type === 'detection_result') {
                    displayDetectionResults(data);
                } else if (data.type === 'disease_detection_result') {
                    console.log('Disease detection result received:', data);
                    
                    const $button = $('[data-action="detect-disease"]');
                    $button.html('<i class="fas fa-search"></i>');
                    $button.prop('disabled', false);
                    
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£ kh√°c nhau cho mobile v√† desktop
                    const isMobile = window.innerWidth < 992;
                    if (isMobile) {
                        showDiseaseToast(data);
                    } else {
                        displayDiseaseResults(data);
                    }
                } else if (data.type === 'detection_error') {
                    console.error('Detection error:', data.message);
                } else {
                    console.log('Unknown message type:', data.type);
                }
            };
            
            videoSocket.onclose = function(e) {
                updateCameraStreamStatus('error');
                
                if (document.getElementById('videoCanvas')) {
                    setTimeout(function() {
                        if (!videoSocket || videoSocket.readyState === WebSocket.CLOSED) {
                            setupVideoWebSocket();
                        }
                    }, 3000);
                }
            };
            
            videoSocket.onerror = function(e) {
                showVideoError('L·ªói k·∫øt n·ªëi WebSocket');
            };
        }
        
        function displayVideoFrame(imageBase64) {
            const canvas = document.getElementById('videoCanvas');
            const ctx = canvas.getContext('2d');
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');
            
            if (!imageBase64) {
                return;
            }
            
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                videoLoading.style.display = 'none';
                videoError.style.display = 'none';
                canvas.style.display = 'block';
                
                updateCameraStreamStatus('connected');
            };
            
            img.onerror = function() {
            };
            
            img.src = 'data:image/jpeg;base64,' + imageBase64;
        }
        
        function showVideoError(message) {
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');
            const canvas = document.getElementById('videoCanvas');
            
            videoLoading.style.display = 'none';
            canvas.style.display = 'none';
            videoError.style.display = 'block';
            
            updateCameraStreamStatus('error');
        }
        
        function setupStatusWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/system_status/`;
            
            statusSocket = new WebSocket(wsUrl);
            
            statusSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                if (data.type === 'status_update') {
                    updateStatusFromWebSocket(data);
                } else if (data.type === 'feed_log') {
                    handleFeedLogUpdate(data.data);
                } else if (data.type === 'device_status') {
                    updateDeviceStatus(data.status);
                } else if (data.type === 'camera_status') {
                    handleCameraStatusUpdate(data.data);
                }
            };
            
            statusSocket.onclose = function(e) {
                setTimeout(setupStatusWebSocket, 5000);
            };
        }
        
        function updateStatusFromWebSocket(data) {
            const $statusElement = $('#deviceStatus');
            $statusElement.removeClass('status-online status-offline')
                       .addClass(`badge fs-6 ${data.device_status === 'online' ? 'status-online' : 'status-offline'}`)
                       .text(data.device_status === 'online' ? 'Online' : 'Offline');
            
            const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
            $deviceConnectionStatus.removeClass('status-online status-offline')
                                  .addClass(data.device_status === 'online' ? 'status-online' : 'status-offline')
                                  .text(data.device_status === 'online' ? 'Online' : 'Offline');
            
            updateModeDisplay(data.current_mode);
            $('#modeSwitch').prop('checked', data.current_mode === 'auto');
            
            if (data.today_feeds !== undefined) {
                const $statsCard = $('.stats-card').eq(3);
                const $countElement = $statsCard.find('.fs-4.fw-bold');
                $countElement.text(data.today_feeds);
            }
        }
        
        function handleFeedLogUpdate(feedData) {
            showAlert('success', `ƒê√£ cho ƒÉn th√†nh c√¥ng (${feedData.mode === 'auto' ? 'T·ª± ƒë·ªông' : 'Th·ªß c√¥ng'})`);
            
            // C·∫≠p nh·∫≠t daily_count
            if (feedData.daily_count !== undefined) {
                const $statsCard = $('.stats-card').eq(3);
                const $countElement = $statsCard.find('.fs-4.fw-bold');
                
                $countElement.fadeOut(200, function() {
                    $countElement.text(feedData.daily_count).fadeIn(200);
                });
                
                $statsCard.addClass('stats-updated');
                setTimeout(function() {
                    $statsCard.removeClass('stats-updated');
                }, 600);
            }
            
            // C·∫≠p nh·∫≠t l·ªãch s·ª≠ cho ƒÉn
            addNewFeedToHistory(feedData);
        }
        
        function addNewFeedToHistory(feedData) {
            const $container = $('.feed-logs-container');
            
            if ($container.length === 0) {
                return; // Kh√¥ng t√¨m th·∫•y container
            }
            
            // Format th·ªùi gian
            const feedTime = new Date(feedData.timestamp).toLocaleString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
            });
            
            // T·∫°o HTML cho feed log m·ªõi
            const newFeedHtml = `
                <div class="feed-log new-feed">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-utensils me-1"></i>
                            ${feedData.mode === 'auto' ? 'T·ª± ƒë·ªông' : 'Th·ªß c√¥ng'}
                        </span>
                        <small class="text-muted">${feedTime}</small>
                    </div>
                </div>
            `;
            
            // Th√™m v√†o ƒë·∫ßu danh s√°ch
            $container.prepend(newFeedHtml);
            
            // Gi·ªØ ch·ªâ 10 entries g·∫ßn nh·∫•t
            const $feedLogs = $container.find('.feed-log');
            if ($feedLogs.length > 10) {
                $feedLogs.slice(10).remove();
            }
            
            // Scroll v·ªÅ top
            $container.scrollTop(0);
            
            // X√≥a class new-feed sau animation
            setTimeout(function() {
                $('.feed-log.new-feed').removeClass('new-feed');
            }, 500);
        }
        
        function updateDeviceStatus(status) {
            const $statusElement = $('#deviceStatus');
            $statusElement.removeClass('status-online status-offline')
                       .addClass(`badge fs-6 ${status === 'online' ? 'status-online' : 'status-offline'}`)
                       .text(status === 'online' ? 'Online' : 'Offline');
            
            const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
            $deviceConnectionStatus.removeClass('status-online status-offline')
                                  .addClass(status === 'online' ? 'status-online' : 'status-offline')
                                  .text(status === 'online' ? 'Online' : 'Offline');
        }
        
        function handleCameraStatusUpdate(cameraInfo) {
            console.log('Camera status update received:', cameraInfo);
            
            if (cameraInfo && cameraInfo.rtsp_url) {
                console.log('RTSP URL updated:', cameraInfo.rtsp_url);
            }
            
            if (cameraInfo && cameraInfo.status) {
                const cameraStatus = cameraInfo.status;
                console.log('Camera status:', cameraStatus);
                
                if (cameraStatus === 'streaming') {
                    updateCameraStreamStatus('connected');
                } else if (cameraStatus === 'error') {
                    updateCameraStreamStatus('error');
                }
            }
        }
        
        window.retryVideoConnection = function() {
            if (videoSocket) {
                videoSocket.close();
            }
            setupVideoWebSocket();
        };
        

        setupVideoWebSocket();
        setupStatusWebSocket();
        
    });
    </script>
{% endblock %}