{% extends 'app/base.html' %}

{% block title %}CatCare Dashboard{% endblock %}

{% block content %}
    <div class="container mt-4">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-wifi fa-2x mb-2"></i>
                    <h6>Trạng thái thiết bị</h6>
                    <span id="deviceStatus" class="badge fs-6 {% if device_status == 'online' %}status-online{% else %}status-offline{% endif %}">
                        {{ device_status|title }}
                    </span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-cogs fa-2x mb-2"></i>
                    <h6>Chế độ hoạt động</h6>
                <span id="currentMode" class="fs-4 fw-bold mode-badge {% if current_mode == 'auto' %}mode-auto{% else %}mode-manual{% endif %}">
                        {% if current_mode == 'auto' %}Tự động{% else %}Thủ công{% endif %}
                    </span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h6>Lịch đã đặt</h6>
                    <span class="fs-4 fw-bold">{{ feeding_schedules.count }}</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <i class="fas fa-utensils fa-2x mb-2"></i>
                    <h6>Lần cho ăn hôm nay</h6>
                    <span class="fs-4 fw-bold">{{ feed_logs.count }}</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Video Stream -->
            <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>Camera trực tiếp
                        </h5>
                    <div class="d-flex align-items-center gap-3">
                        <div id="cameraStatus" class="camera-status">
                            <i class="fas fa-video me-1"></i>Đang kết nối...
                        </div>
                        <div id="deviceConnectionStatus" class="device-status">
                            <i class="fas fa-wifi me-1"></i>
                            <span class="badge {% if device_status == 'online' %}status-online{% else %}status-offline{% endif %}">
                                {{ device_status|title }}
                            </span>
                        </div>
                    </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="video-container">
                            <canvas id="videoCanvas" class="video-stream" style="display: none;"></canvas>
                            <div id="videoLoading" class="video-loading">
                                <div class="text-center p-5">
                                    <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                                    <p>Đang kết nối RTSP stream...</p>
                                </div>
                            </div>
                            <div id="videoError" class="video-error" style="display: none;">
                                <div class="text-center p-5">
                                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                                    <p>Không thể kết nối RTSP stream</p>
                                    <button class="btn btn-primary btn-sm" onclick="retryVideoConnection()">
                                        <i class="fas fa-redo me-1"></i>Thử lại
                                    </button>
                                </div>
                            </div>
                            <div class="position-absolute top-0 end-0 p-3">
                            <button class="btn btn-detect" data-action="detect-disease">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Disease Detection Results - Desktop Only -->
                <div class="mt-3 d-none d-lg-block">
                    <div id="diseaseResults" style="display: none;"></div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="col-lg-4">
                <!-- Manual Feed -->
            <div class="card mb-4 d-none">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">
                            <i class="fas fa-hand-paper me-2"></i>Điều khiển thủ công
                        </h6>
                    </div>
                    <div class="card-body text-center">
                    <button class="btn btn-feed w-100 mb-3" data-action="manual-feed">
                            <i class="fas fa-utensils me-2"></i>Cho ăn ngay
                        </button>
                        <div class="form-check form-switch d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" id="modeSwitch" 
                               {% if current_mode == 'auto' %}checked{% endif %} data-action="toggle-mode">
                            <label class="form-check-label ms-2" for="modeSwitch">
                                Chế độ tự động
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Recent Feeding Logs -->
                <div class="card mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-history me-2"></i>Lịch sử cho ăn gần đây
                        </h6>
                    <a href="{% url 'app:feeding_history' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list me-1"></i>Xem tất cả
                    </a>
                    </div>
                    <div class="card-body">
                        {% if feed_logs %}
                        <div class="feed-logs-container">
                            {% for log in feed_logs %}
                            <div class="feed-log">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-utensils me-1"></i>
                                        {% if log.mode == 'auto' %}Tự động{% else %}Thủ công{% endif %}
                                    </span>
                                    <small class="text-muted">{{ log.timestamp|date:"H:i d/m" }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                            <p class="text-muted text-center">Chưa có lịch sử cho ăn</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Feeding Schedules -->
                <div class="card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Lịch cho ăn
                        </h6>
                    <a href="{% url 'app:settings' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Thêm lịch
                    </a>
                    </div>
                    <div class="card-body">
                        {% if feeding_schedules %}
                        <div class="schedule-container">
                            {% for schedule in feeding_schedules %}
                            <div class="schedule-item">
                                <i class="fas fa-clock me-2"></i>
                                {{ schedule.time|time:"H:i" }}
                                {% if schedule.enabled %}
                                    <span class="badge bg-success ms-2">Hoạt động</span>
                                {% else %}
                                    <span class="badge bg-secondary ms-2">Tắt</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                            <p class="text-muted text-center">Chưa có lịch cho ăn</p>
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Toast Container for Mobile -->
    <div class="toast-container position-fixed top-0 end-0 p-3 d-lg-none">
        <div id="diseaseToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-cat text-primary me-2"></i>
                <strong class="me-auto"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="diseaseToastBody">
                <!-- Toast content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Floating Controls -->
<!-- Desktop Version -->
<div class="floating-controls d-none d-md-flex flex-column">
    <button class="control-btn control-feed" data-action="manual-feed">
            <i class="fas fa-utensils"></i>
        </button>
    <button class="control-btn control-detect" data-action="detect-disease">
            <i class="fas fa-search"></i>
        </button>
    <button class="control-btn control-mode" data-action="toggle-mode-quick">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<!-- Mobile FAB Menu -->
<div class="floating-controls d-md-none">
    <div class="mobile-fab-menu">
        <div class="fab-options" id="fabOptions">
            <button class="control-btn control-mode" data-action="toggle-mode-quick" data-close-fab="true" title="Đổi chế độ">
            <i class="fas fa-sync-alt"></i>
            </button>
            <button class="control-btn control-detect" data-action="detect-disease" data-close-fab="true" title="Phát hiện bệnh">
                <i class="fas fa-search"></i>
            </button>
            <button class="control-btn control-feed" data-action="manual-feed" data-close-fab="true" title="Cho ăn">
                <i class="fas fa-utensils"></i>
            </button>
        </div>
        <button class="fab-main" id="fabMain" data-action="toggle-fab-menu">
            <i class="fas fa-plus"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>
    $(document).ready(function() {
        $('body').append('<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">');
        
        let videoSocket = null;
        let statusSocket = null;
        
        function getCsrfToken() {
            return $('[name=csrfmiddlewaretoken]').val();
        }

        function manualFeed() {
            $.ajax({
                url: "{% url 'app:manual_feed' %}",
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                success: function(data) {
                if (data.success) {
                    showAlert('success', data.message);
                        updateFeedingData();
                        setTimeout(updateStatus, 1000);
                } else {
                    showAlert('danger', data.message);
                }
                },
                error: function() {
                showAlert('danger', 'Lỗi kết nối');
                }
            });
        }

        function toggleMode() {
            const isAuto = $('#modeSwitch').is(':checked');
            const mode = isAuto ? 'auto' : 'manual';
            
            $.ajax({
                url: "{% url 'app:change_mode' %}",
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({mode: mode}),
                success: function(data) {
                if (data.success) {
                    updateModeDisplay(data.mode);
                    showAlert('success', `Đã chuyển sang chế độ ${data.mode === 'auto' ? 'tự động' : 'thủ công'}`);
                } else {
                        $('#modeSwitch').prop('checked', !isAuto);
                    showAlert('danger', data.message);
                    }
                },
                error: function() {
                    $('#modeSwitch').prop('checked', !isAuto);
                    showAlert('danger', 'Lỗi kết nối');
                }
            });
        }

        let detectionActive = false;

        function detectDisease() {
            if (!detectionActive) {
                detectionActive = true;
                
                if (videoSocket && videoSocket.readyState === WebSocket.OPEN) {
                    videoSocket.send(JSON.stringify({command: 'start_detection'}));
                    showAlert('info', 'Bắt đầu phát hiện bệnh...');
                    
                    $('[data-action="detect-disease"]').html('<i class="fas fa-stop me-1"></i>');
                } else {
                    showAlert('danger', 'Chưa kết nối video stream');
                }
            } else {
                detectionActive = false;
                
                if (videoSocket && videoSocket.readyState === WebSocket.OPEN) {
                    videoSocket.send(JSON.stringify({command: 'stop_detection'}));
                    showAlert('info', 'Đã dừng phát hiện bệnh');
                }
                
                // Reset nút detect về trạng thái ban đầu
                $('[data-action="detect-disease"]').html('<i class="fas fa-search"></i>');
                
                // Ẩn kết quả detection
                $('#diseaseResults').hide();
                
                // Ẩn toast nếu có
                const toast = bootstrap.Toast.getInstance(document.getElementById('diseaseToast'));
                if (toast) {
                    toast.hide();
                }
            }
        }
        
        function displayDetectionResults(data) {
            const isMobile = window.innerWidth < 992;
            
            if (isMobile) {
                showDiseaseToast(data);
            } else {
                showDiseaseAlert(data);
            }
            
            updateDetectionCameraStatus(data);
        }
        
        function showDiseaseAlert(data) {
            const $resultsDiv = $('#diseaseResults');
            
            let html = '';
            let alertType = 'info';
            
            if (data.cat_detected) {
                if (data.diseases.length > 0) {
                    alertType = 'warning';
                    html = `<div class="alert alert-${alertType} alert-dismissible fade show">
                        <h6><i class="fas fa-cat me-2"></i>Phát hiện mèo (${data.cat_confidence}%) - Có ${data.total_detections} bệnh được phát hiện:</h6>`;
                    
                    data.diseases.forEach((disease, index) => {
                        html += `<div class="disease-alert mt-2">
                            <strong>${disease.disease}</strong> - Độ tin cậy: ${disease.confidence}%
                            <small class="text-muted d-block">(${disease.english_name})</small>
                        </div>`;
                    });
                    
                    html += `<button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button></div>`;
                } else {
                    alertType = 'success';
                    html = `<div class="alert alert-${alertType} alert-dismissible fade show">
                        <i class="fas fa-cat me-2"></i>Phát hiện mèo khỏe mạnh (${data.cat_confidence}%)
                        <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                    </div>`;
                }
            } else {
                alertType = 'info';
                html = `<div class="alert alert-${alertType} alert-dismissible fade show">
                    <i class="fas fa-search me-2"></i>Không phát hiện mèo trong video
                    <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="closeDiseaseResults()"></button>
                </div>`;
            }
            
            $resultsDiv.html(html);
            $resultsDiv.show();
        }
        
        function showDiseaseToast(data) {
            const $toastBody = $('#diseaseToastBody');
            const $toast = $('#diseaseToast');
            
            let content = '';
            let toastClass = 'text-bg-info';
            
            if (data.cat_detected) {
                if (data.diseases.length > 0) {
                    toastClass = 'text-bg-warning';
                    content = `<strong>Phát hiện mèo (${data.cat_confidence}%)</strong><br>`;
                    content += `<small>Có ${data.total_detections} bệnh được phát hiện:</small><br>`;
                    
                    data.diseases.forEach((disease, index) => {
                        content += `<small>• ${disease.disease} (${disease.confidence}%)</small><br>`;
                    });
                } else {
                    toastClass = 'text-bg-success';
                    content = `<strong>Phát hiện mèo khỏe mạnh</strong><br><small>Độ tin cậy: ${data.cat_confidence}%</small>`;
                }
            } else {
                toastClass = 'text-bg-info';
                content = '<strong>Không phát hiện mèo</strong><br><small>Đang tiếp tục tìm kiếm...</small>';
            }
            
            $toast.removeClass('text-bg-success text-bg-warning text-bg-info').addClass(toastClass);
            $toastBody.html(content);
            
            const toast = new bootstrap.Toast($toast[0], {
                delay: 5000 
            });
            toast.show();
        }
        
        function updateDetectionCameraStatus(data) {
            if (data.cat_detected) {
                if (data.diseases && data.diseases.length > 0) {
                    updateCameraStatus({
                        detection_info: {
                            cat_detected: true,
                            confidence: data.cat_confidence,
                            disease_detected: true,
                            disease_name: data.diseases[0].disease,
                            disease_confidence: data.diseases[0].confidence
                        }
                    });
                } else {
                    updateCameraStatus({
                        detection_info: {
                            cat_detected: true,
                            confidence: data.cat_confidence,
                            disease_detected: false
                        }
                    });
                }
            } else {
                updateCameraStatus({
                    detection_info: {
                        cat_detected: false,
                        confidence: 0,
                        disease_detected: false
                    }
                });
            }
        }
        
        function closeDiseaseResults() {
            $('#diseaseResults').hide();
        }
        
        // Event delegation cho nút close được tạo động
        $(document).on('click', '#diseaseResults .btn-close', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeDiseaseResults();
        });
        
        // Event delegation cho toast close
        $(document).on('click', '#diseaseToast .btn-close', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const toast = bootstrap.Toast.getInstance(document.getElementById('diseaseToast'));
            if (toast) {
                toast.hide();
            }
        });

        function displayDiseaseResults(data) {
            const $resultsDiv = $('#diseaseResults');
            
            if (data.success) {
                let html = '';
                
                if (data.cat_detected) {
                if (data.diseases.length > 0) {
                        html = `<div class="alert alert-custom alert-warning">
                            <h6><i class="fas fa-cat me-2"></i>Phát hiện mèo (${data.cat_confidence}%) - Có ${data.total_detections} bệnh được phát hiện:</h6>`;
                    
                        data.diseases.forEach((disease, index) => {
                        html += `<div class="disease-alert mt-3">
                                <strong>${disease.disease}</strong> - Độ tin cậy: ${disease.confidence}%
                                <small class="text-muted d-block">(${disease.english_name})</small>
                        </div>`;
                    });
                    
                    html += '</div>';
                        
                        const topDisease = data.diseases[0];
                        updateCameraStatus({
                            device_status: 'online',
                            detection_info: {
                                cat_detected: true,
                                confidence: data.cat_confidence,
                                disease_detected: true,
                                disease_name: topDisease.disease,
                                disease_confidence: topDisease.confidence
                            }
                        });
                    } else {
                        html = `<div class="alert alert-custom alert-success">
                            <i class="fas fa-cat me-2"></i>Phát hiện mèo khỏe mạnh (${data.cat_confidence}%)
                        </div>`;
                        
                        updateCameraStatus({
                            device_status: 'online',
                            detection_info: {
                                cat_detected: true,
                                confidence: data.cat_confidence,
                                disease_detected: false
                            }
                        });
                    }
                } else {
                    html = '<div class="alert alert-custom alert-info"><i class="fas fa-search me-2"></i>Không phát hiện mèo trong hình ảnh</div>';
                    
                    updateCameraStatus({
                        device_status: 'online',
                        detection_info: {
                            cat_detected: false,
                            confidence: 0,
                            disease_detected: false
                        }
                    });
                }
                
                $resultsDiv.html(html);
            } else {
                $resultsDiv.html(`<div class="alert alert-custom alert-danger"><i class="fas fa-times-circle me-2"></i>${data.message}</div>`);
            }
            
            $resultsDiv.show();
            $resultsDiv[0].scrollIntoView({behavior: 'smooth'});
        }

        function updateModeDisplay(mode) {
            const $modeElement = $('#currentMode');
            $modeElement.removeClass('mode-auto mode-manual').addClass(`mode-badge ${mode === 'auto' ? 'mode-auto' : 'mode-manual'}`);
            $modeElement.text(mode === 'auto' ? 'Tự động' : 'Thủ công');
        }

        function updateStatus() {
            $.ajax({
                url: "{% url 'app:get_status' %}",
                method: 'GET',
                success: function(data) {
                    const $statusElement = $('#deviceStatus');
                    $statusElement.removeClass('status-online status-offline')
                               .addClass(`badge fs-6 ${data.device_status === 'online' ? 'status-online' : 'status-offline'}`)
                               .text(data.device_status === 'online' ? 'Online' : 'Offline');
                    
                    const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
                    $deviceConnectionStatus.removeClass('status-online status-offline')
                                          .addClass(data.device_status === 'online' ? 'status-online' : 'status-offline')
                                          .text(data.device_status === 'online' ? 'Online' : 'Offline');
                
                    updateModeDisplay(data.current_mode);
                    $('#modeSwitch').prop('checked', data.current_mode === 'auto');
                    
                },
                error: function() {
                    console.log('Lỗi cập nhật trạng thái');
                    const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
                    $deviceConnectionStatus.removeClass('status-online status-offline')
                                          .addClass('status-offline')
                                          .text('API Error');
                }
            });
        }

        function updateCameraStatus(data) {
            const $cameraStatus = $('#cameraStatus');
            
            $cameraStatus.removeClass('error disease-detected healthy');
            
            if (data.camera_error) {
                $cameraStatus.addClass('error')
                            .html(`<i class="fas fa-exclamation-triangle me-1"></i>${data.camera_error}`);
            } else if (data.detection_info) {
                const detection = data.detection_info;
                if (detection.disease_detected) {
                    $cameraStatus.addClass('disease-detected')
                                .html(`<i class="fas fa-virus me-1"></i>${detection.disease_name} (${detection.disease_confidence}%)`);
                } else if (detection.cat_detected) {
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-cat me-1"></i>Phát hiện mèo (${detection.confidence}%)`);
                } else {
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-search me-1"></i>Đang tìm kiếm mèo...`);
                }
            } else if (data.disease_info && data.disease_info.detected) {
                const disease = data.disease_info;
                $cameraStatus.addClass('disease-detected')
                            .html(`<i class="fas fa-virus me-1"></i>${disease.name} (${disease.confidence}%)`);
            } else {
                $cameraStatus.addClass('healthy')
                            .html(`<i class="fas fa-video me-1"></i>Camera sẵn sàng`);
            }
        }
        
        function updateCameraStreamStatus(status) {
            const $cameraStatus = $('#cameraStatus');
            $cameraStatus.removeClass('error disease-detected healthy');
            
            switch(status) {
                case 'connecting':
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-spinner fa-spin me-1"></i>Đang kết nối camera...`);
                    break;
                case 'connected':
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-video me-1"></i>Camera hoạt động`);
                    break;
                case 'error':
                    $cameraStatus.addClass('error')
                                .html(`<i class="fas fa-exclamation-triangle me-1"></i>Lỗi camera stream`);
                    break;
                default:
                    $cameraStatus.addClass('healthy')
                                .html(`<i class="fas fa-video me-1"></i>Camera sẵn sàng`);
            }
        }

        function updateFeedingData() {
            $.ajax({
                url: "{% url 'app:get_feeding_data' %}",
                method: 'GET',
                success: function(data) {
                    if (data.success) {
                        const $statsCard = $('.stats-card').eq(3);
                        const $countElement = $statsCard.find('.fs-4.fw-bold');
                        
                        $countElement.text(data.today_feed_count);
                        $statsCard.addClass('stats-updated');
                        
                        setTimeout(function() {
                            $statsCard.removeClass('stats-updated');
                        }, 600);
                        
                        updateFeedingHistory(data.recent_feeds);
                    }
                },
                error: function() {
                    console.log('Lỗi cập nhật dữ liệu cho ăn');
                }
            });
        }

        function updateFeedingHistory(feeds) {
            const $container = $('.feed-logs-container');
            
            if (feeds && feeds.length > 0) {
                let html = '';
                feeds.forEach(function(feed, index) {
                    const feedTime = new Date(feed.timestamp).toLocaleString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        day: '2-digit',
                        month: '2-digit'
                    });
                    
                    const newFeedClass = index === 0 ? 'new-feed' : '';
                    
                    html += `
                        <div class="feed-log ${newFeedClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="fas fa-utensils me-1"></i>
                                    ${feed.mode === 'auto' ? 'Tự động' : 'Thủ công'}
                                </span>
                                <small class="text-muted">${feedTime}</small>
                            </div>
                        </div>
                    `;
                });
                
                $container.html(html);
                
                $container.scrollTop(0);
                
                setTimeout(function() {
                    $('.feed-log.new-feed').removeClass('new-feed');
                }, 500);
            } else {
                $container.parent().html('<p class="text-muted text-center">Chưa có lịch sử cho ăn</p>');
            }
        }

        function showAlert(type, message) {
            const $alertDiv = $(`
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append($alertDiv);
            
            setTimeout(function() {
                $alertDiv.remove();
            }, 5000);
        }

        // FAB Menu Controls
        function toggleFabMenu() {
            $('#fabMain, #fabOptions').toggleClass('active');
        }
        
        function closeFabMenu() {
            $('#fabMain, #fabOptions').removeClass('active');
        }
        
        function toggleModeQuick() {
            const $modeSwitch = $('#modeSwitch');
            if ($modeSwitch.length) {
                $modeSwitch.prop('checked', !$modeSwitch.is(':checked'));
                toggleMode();
            }
        }

        // Event handlers
        $(document).on('click', '[data-action="manual-feed"]', function() {
            manualFeed();
            if ($(this).data('close-fab')) closeFabMenu();
        });

        $(document).on('change', '[data-action="toggle-mode"]', function() {
            toggleMode();
        });

        $(document).on('click', '[data-action="detect-disease"]', function() {
            detectDisease();
            if ($(this).data('close-fab')) closeFabMenu();
        });

        $(document).on('click', '[data-action="toggle-mode-quick"]', function() {
            toggleModeQuick();
            if ($(this).data('close-fab')) closeFabMenu();
        });

        $(document).on('click', '[data-action="toggle-fab-menu"]', function() {
            toggleFabMenu();
        });

        function setupVideoWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/video_stream/`;
            
            updateCameraStreamStatus('connecting');
            
            videoSocket = new WebSocket(wsUrl);
            
            videoSocket.onopen = function(e) {
                videoSocket.send(JSON.stringify({command: 'start_stream'}));
            };
            
            videoSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                if (data.type === 'video_frame') {
                    displayVideoFrame(data.image);
                } else if (data.type === 'error') {
                    showVideoError(data.message);
                } else if (data.type === 'status') {
                    updateCameraStreamStatus('connecting');
                } else if (data.type === 'detection_result') {
                    displayDetectionResults(data);
                } else if (data.type === 'detection_error') {
                    console.error('Detection error:', data.message);
                }
            };
            
            videoSocket.onclose = function(e) {
                updateCameraStreamStatus('error');
                
                if (document.getElementById('videoCanvas')) {
                    setTimeout(function() {
                        if (!videoSocket || videoSocket.readyState === WebSocket.CLOSED) {
                            setupVideoWebSocket();
                        }
                    }, 3000);
                }
            };
            
            videoSocket.onerror = function(e) {
                showVideoError('Lỗi kết nối WebSocket');
            };
        }
        
        function displayVideoFrame(imageBase64) {
            const canvas = document.getElementById('videoCanvas');
            const ctx = canvas.getContext('2d');
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');
            
            if (!imageBase64) {
                return;
            }
            
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                videoLoading.style.display = 'none';
                videoError.style.display = 'none';
                canvas.style.display = 'block';
                
                updateCameraStreamStatus('connected');
            };
            
            img.onerror = function() {
            };
            
            img.src = 'data:image/jpeg;base64,' + imageBase64;
        }
        
        function showVideoError(message) {
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');
            const canvas = document.getElementById('videoCanvas');
            
            videoLoading.style.display = 'none';
            canvas.style.display = 'none';
            videoError.style.display = 'block';
            
            updateCameraStreamStatus('error');
        }
        
        function setupStatusWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/system_status/`;
            
            statusSocket = new WebSocket(wsUrl);
            
            statusSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                if (data.type === 'status_update') {
                    updateStatusFromWebSocket(data);
                } else if (data.type === 'feed_log') {
                    handleFeedLogUpdate(data.data);
                } else if (data.type === 'device_status') {
                    updateDeviceStatus(data.status);
                }
            };
            
            statusSocket.onclose = function(e) {
                setTimeout(setupStatusWebSocket, 5000);
            };
        }
        
        function updateStatusFromWebSocket(data) {
            const $statusElement = $('#deviceStatus');
            $statusElement.removeClass('status-online status-offline')
                       .addClass(`badge fs-6 ${data.device_status === 'online' ? 'status-online' : 'status-offline'}`)
                       .text(data.device_status === 'online' ? 'Online' : 'Offline');
            
            const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
            $deviceConnectionStatus.removeClass('status-online status-offline')
                                  .addClass(data.device_status === 'online' ? 'status-online' : 'status-offline')
                                  .text(data.device_status === 'online' ? 'Online' : 'Offline');
            
            updateModeDisplay(data.current_mode);
            $('#modeSwitch').prop('checked', data.current_mode === 'auto');
            
            const $statsCard = $('.stats-card').eq(3);
            const $countElement = $statsCard.find('.fs-4.fw-bold');
            $countElement.text(data.today_feeds);
        }
        
        function handleFeedLogUpdate(feedData) {
            showAlert('success', `Đã cho ăn thành công (${feedData.mode === 'auto' ? 'Tự động' : 'Thủ công'})`);
            updateFeedingData();
            
            const $statsCard = $('.stats-card').eq(3);
            $statsCard.addClass('stats-updated');
            setTimeout(function() {
                $statsCard.removeClass('stats-updated');
            }, 600);
        }
        
        function updateDeviceStatus(status) {
            const $statusElement = $('#deviceStatus');
            $statusElement.removeClass('status-online status-offline')
                       .addClass(`badge fs-6 ${status === 'online' ? 'status-online' : 'status-offline'}`)
                       .text(status === 'online' ? 'Online' : 'Offline');
            
            const $deviceConnectionStatus = $('#deviceConnectionStatus .badge');
            $deviceConnectionStatus.removeClass('status-online status-offline')
                                  .addClass(status === 'online' ? 'status-online' : 'status-offline')
                                  .text(status === 'online' ? 'Online' : 'Offline');
        }
        
        window.retryVideoConnection = function() {
            if (videoSocket) {
                videoSocket.close();
            }
            setupVideoWebSocket();
        };
        
        setupVideoWebSocket();
        setupStatusWebSocket();
        
    });
    </script>
{% endblock %}